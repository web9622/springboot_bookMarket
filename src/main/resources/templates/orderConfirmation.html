<html>
<head>
    <title>주문 정보</title>
    <link href="/BookMarket/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <style>
        #payment-button {
            width: 100%;
            padding: 15px;
            background: #3182f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        #payment-button:hover {
            background: #1b64da;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <th:block th:replace="~{/module/header}"></th:block>

    <div class="p-5 mb-4 bg-body-tertiary rounded-3">
        <div class="container-fluid py-5">
            <h1 class="display-5 fw-bold">주문 정보 </h1>
            <p class="col-md-8 fs-4">BookMarket</p>
        </div>

    </div>
    <div class="row align-items-md-stretch">
        <form th:object="${order}" th:action="@{/order/orderCompleted}" method="post">
            <div class="container  col-md-10  py-5" style="background:#fafafe">
                <div class="text-center">
                    <h1>영수증</h1>
                </div>
                <div class="row  text-left">
                    <div class="col-md-6  py-3">

                        <strong>배송 주소</strong><br>
                        성명 : [[${order.shipping.name}]]<br>
                        우편번호 : [[${order.shipping.address.zipCode}]]<br>
                        주소 : [[${order.shipping.address.addressName}]] [[${order.shipping.address.detailAddress}]]
                        ([[${order.shipping.address.country}]])<br>

                    </div>
                    <div class="col-md-6 text-right py-3">
                        <p><em>배송일: [[${order.shipping.date}]]</em></p>
                    </div>

                </div>
                <div class="row text-left">
                    <div class="col-md-6 py-2">
                        <address>
                            <strong>청구주소</strong> <br>
                            성명 : [[${order?.shipping?.name}]]<br>
                            우편번호 : [[${order?.shipping?.address?.zipCode}]]<br>
                            주소 : [[${order?.shipping?.address?.addressName}]] [[${order?.shipping?.address?.detailAddress}]]
                            ([[${order?.shipping?.address?.country}]])<br>
                        </address>
                    </div>
                </div>

                <div class="row  py-2">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>도서</th>
                            <th>수량</th>
                            <th class="text-center">가격</th>
                            <th class="text-center">소계</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="cartItem : ${order.orderItems}">
                            <td>
                                <em th:each="book : ${bookList}"
                                    th:if="${#strings.equals(book.bookId, cartItem.value.bookId)}"
                                    th:text="${book.name}"></em>
                            </td>
                            <td style="text-align: center" th:text="${cartItem.value.quantity}"></td>
                            <td class="text-center">
            <span th:each="book : ${bookList}"
                  th:if="${#strings.equals(book.bookId, cartItem.value.bookId)}"
                  th:text="${book.unitPrice + '원'}"></span>
                            </td>
                            <td class="text-center" th:text="${cartItem.value.totalPrice + '원'}"></td>

                        </tr>
                        <tr>
                            <td colspan="3" class="text-right"><strong>총 금액</strong></td>
                            <td class="text-center">
                                <strong>
                                    <h4 th:text="|${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')}원|"></h4>
                                </strong>
                            </td>
                        </tr>
                        <tr><td colspan="4"><button id="payment-button" type="button">토스페이 결제하기</button></td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="container col-md-5  py-3">

                    <a href="/BookMarket/order/orderShippingInfo" class=" btn btn-secondary" role="button">이전</a>
                    <input type="submit" class="btn btn-success" value="주문완료"/>
                    <a href="/BookMarket/order/orderCancelled" class="btn btn-secondary" role="button">취소</a>
                </div>
        </form>
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    // 토스페이먼츠 클라이언트 키 (발급받은 테스트 키로 변경하세요)
    const clientKey = 'test_ck_KNbdOvk5rkOMwZbg4jlyrn07xlzm'; // ⚠️ 여기에 발급받은 클라이언트 키 입력
    const tossPayments = TossPayments(clientKey);

    // 주문 정보 가져오기
    const customerName = /*[[${order.shipping.name}]]*/ '구매자';
    const totalAmount = /*[[${order.totalPrice}]]*/ 0;

    // 주문 상품명 만들기 - bookList에서 첫 번째 도서명 추출
    let orderName = '도서';
    const itemCount = /*[[${#lists.size(order.orderItems)}]]*/ 0;

    // bookList의 첫 번째 도서의 name 속성 가져오기
    /*[# th:if="${not #lists.isEmpty(bookList)}"]*/
        orderName = /*[[${bookList[0].name}]]*/ '도서';
    /*[/]*/

    // 2권 이상인 경우 "외 N권" 추가
    if (itemCount > 1) {
        orderName += ' 외 ' + (itemCount - 1) + '권';
    }

    // 결제 버튼 클릭 이벤트
    document.getElementById('payment-button').addEventListener('click', function() {
        // 금액 확인
        if (totalAmount <= 0) {
            alert('결제 금액이 올바르지 않습니다.');
            return;
        }

        // 고유한 주문번호 생성
        const orderId = 'ORDER_' + new Date().getTime();

        console.log('결제 정보:', {
            amount: totalAmount,
            orderId: orderId,
            orderName: orderName,
            customerName: customerName
        });

        // 토스페이먼츠 결제창 호출
        tossPayments.requestPayment('카드', {
            amount: totalAmount,
            orderId: orderId,
            orderName: orderName,
            customerName: customerName,
            successUrl: window.location.origin + '/BookMarket/payment/success',
            failUrl: window.location.origin + '/BookMarket/payment/fail',
        }).catch(function (error) {
            if (error.code === 'USER_CANCEL') {
                alert('결제를 취소하였습니다.');
            } else if (error.code === 'INVALID_CARD_COMPANY') {
                alert('유효하지 않은 카드입니다.');
            } else {
                console.error('결제 오류:', error);
                alert('결제 중 오류가 발생했습니다: ' + error.message);
            }
        });
    });
    /*]]>*/
</script>
</body>
</html>